name: Deploy Marketing Dashboard

on:
  push:
    branches: [ main ]
    paths:
      - 'dashboard.py'
      - 'dashboard_config.yaml'
      - 'dashboard_requirements.txt'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install -r dashboard_requirements.txt
        pip install streamlit
        pip install gunicorn
        
    - name: Create deployment files
      run: |
        # Create requirements.txt for deployment
        cat > requirements.txt << EOF
        streamlit>=1.28.0
        pandas>=2.0.0
        plotly>=5.15.0
        numpy>=1.24.0
        pyyaml>=6.0
        google-ads>=22.0.0
        rich>=13.0.0
        gunicorn>=21.0.0
        EOF
        
        # Create Procfile for deployment
        cat > Procfile << EOF
        web: streamlit run dashboard.py --server.port=\$PORT --server.address=0.0.0.0
        EOF
        
        # Create .streamlit/config.toml
        mkdir -p .streamlit
        cat > .streamlit/config.toml << EOF
        [server]
        port = 8501
        address = "0.0.0.0"
        enableCORS = false
        enableXsrfProtection = false
        
        [browser]
        gatherUsageStats = false
        
        [theme]
        primaryColor = "#1f77b4"
        backgroundColor = "#ffffff"
        secondaryBackgroundColor = "#f0f2f6"
        textColor = "#262730"
        EOF
        
    - name: Deploy to Streamlit Cloud
      env:
        STREAMLIT_SHARING_MODE: "external"
        STREAMLIT_SERVER_PORT: "8501"
        STREAMLIT_SERVER_ADDRESS: "0.0.0.0"
      run: |
        echo "Dashboard ready for Streamlit Cloud deployment"
        echo "Visit: https://share.streamlit.io/ELevine-RE/google-ads-analysis/main/dashboard.py"
        
    - name: Create deployment instructions
      run: |
        cat > DEPLOYMENT_INSTRUCTIONS.md << 'EOF'
        # ðŸš€ Dashboard Deployment Instructions
        
        ## Option 1: Streamlit Cloud (Recommended)
        
        1. Go to [Streamlit Cloud](https://share.streamlit.io/)
        2. Sign in with your GitHub account
        3. Click "New app"
        4. Select this repository: `ELevine-RE/google-ads-analysis`
        5. Set main file path: `dashboard.py`
        6. Click "Deploy"
        
        Your dashboard will be available at: `https://share.streamlit.io/ELevine-RE/google-ads-analysis/main/dashboard.py`
        
        ## Option 2: Heroku
        
        1. Install Heroku CLI
        2. Run: `heroku create your-dashboard-name`
        3. Run: `git push heroku main`
        4. Set environment variables in Heroku dashboard
        
        ## Option 3: Railway
        
        1. Go to [Railway](https://railway.app/)
        2. Connect your GitHub repository
        3. Deploy automatically
        
        ## Environment Variables Required
        
        Set these in your deployment platform:
        - `GOOGLE_ADS_DEVELOPER_TOKEN`
        - `GOOGLE_ADS_CLIENT_ID`
        - `GOOGLE_ADS_CLIENT_SECRET`
        - `GOOGLE_ADS_REFRESH_TOKEN`
        - `GOOGLE_ADS_LOGIN_CUSTOMER_ID`
        
        EOF
        
    - name: Commit deployment files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add requirements.txt Procfile .streamlit/ DEPLOYMENT_INSTRUCTIONS.md
        git commit -m "Add deployment configuration for dashboard" || echo "No changes to commit"
        
    - name: Push deployment files
      run: |
        git push origin main
      permissions:
        contents: write
